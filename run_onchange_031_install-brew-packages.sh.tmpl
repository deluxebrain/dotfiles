#!/bin/bash

set -euo pipefail

echo "[Configuration] Installing brew packages..."

{{- if .installAppStorePackages }}
echo "[Warning] App Store packages are enabled and require you to be signed into the Mac App Store."
read -p "Press Enter to continue or Ctrl+C to cancel..."
{{- end }}

# Keep sudo session alive
echo "[Notice] Some packages will require administrator privileges. Please enter your password when prompted."
sudo -v
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# Load Homebrew environment variables only if not already loaded
if ! command -v brew &>/dev/null; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Update Homebrew
brew update

# Install packages
{{- $isFull := eq .installType "full" }}
{{- $packageGroups := dict
    "core" true
    "development" $isFull
    "cloud_and_infrastructure" $isFull
    "data_and_database" $isFull
    "system_and_network" $isFull
    "media_and_documentation" $isFull
    "app_store" .installAppStorePackages }}

{{- range $group, $enabled := $packageGroups }}
echo "[Configuration] {{ $group }} packages: {{ if $enabled }}✓ enabled{{ else }}✗ skipped{{ end }}"
{{- if $enabled }}
echo "[Installing] Starting installation of {{ $group }} packages..."
brew bundle --file=/dev/stdin <<EOF
{{- range index $.brew_packages $group "taps" }}
{{- if not (has . (default (list) $.brew_exclusions.taps)) }}
tap {{ . | quote }}
{{- end }}
{{- end }}
{{ range index $.brew_packages $group "brews" }}
{{- if not (has . (default (list) $.brew_exclusions.brews)) }}
brew {{ . | quote }}
{{- end }}
{{- end }}
{{- range index $.brew_packages $group "casks" }}
{{- if not (has . (default (list) $.brew_exclusions.casks)) }}
cask {{ . | quote }}
{{- end }}
{{- end }}
{{- range index $.brew_packages $group "mas" }}
{{- if not (has .name (default (list) $.brew_exclusions.mas)) }}
mas {{ .name | quote }}, id: {{ .id }}
{{- end }}
{{- end }}
EOF
{{- range index $.brew_packages $group "links" }}
brew link {{ . | quote }} --force
{{- end }}
{{- end }}
{{- end }}

# Report pinned packages
echo "[Information] Checking for pinned packages..."
PINNED_PACKAGES=$(brew list --pinned 2>/dev/null || echo "")

if [ -z "$PINNED_PACKAGES" ]; then
    echo "[Information] No pinned packages found."
else
    echo "[Information] The following packages are pinned and will not be upgraded automatically:"
    echo "$PINNED_PACKAGES" | while read pkg; do
        echo " - $pkg"
    done
fi
